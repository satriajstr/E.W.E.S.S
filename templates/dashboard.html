<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EWESS Dashboard</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
        }
    </style>
</head>

<body class="p-6">
    <h1 class="text-3xl font-bold mb-6">EWESS – Monitoring Dashboard</h1>

    <!-- GRID LAYOUT -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- REALTIME STATUS CARD -->
        <div class="card col-span-1">
            <h2 class="text-xl font-semibold mb-4">Realtime Status</h2>

            <p class="mb-2">Shake Status:
                <span id="shakeStatus" class="font-bold text-blue-300">Loading...</span>
            </p>

            <p class="mb-2">Intensity:
                <span id="intensity" class="font-bold text-green-300">0</span>
            </p>

            <p class="mb-2">Duration:
                <span id="duration" class="font-bold text-yellow-300">0</span> sec
            </p>

            <p class="text-sm">Updated:
                <span id="timestamp" class="text-gray-300">-</span>
            </p>
        </div>

        <!-- STATISTIK CARD -->
        <div class="card col-span-1">
            <h2 class="text-xl font-semibold mb-4">Statistik Intensitas (24 Jam)</h2>

            <p>Average:
                <span id="avgIntensity" class="font-bold text-blue-400">0</span>
            </p>

            <p>Minimum:
                <span id="minIntensity" class="font-bold text-green-400">0</span>
            </p>

            <p>Maximum:
                <span id="maxIntensity" class="font-bold text-red-400">0</span>
            </p>
        </div>

        <!-- CHART CARD -->
        <div class="card col-span-1 md:col-span-1">
            <h2 class="text-xl font-semibold mb-4">Max Intensity per Event</h2>
            <canvas id="realtimeChart"></canvas>
        </div>
    </div>


    <!-- LOG TABLE (EVENT-BASED) -->
    <div class="card mt-8">
        <h2 class="text-xl font-semibold mb-4">Event Log History (Latest)</h2>

        <div class="overflow-y-auto max-h-96">
            <table class="min-w-full text-left text-sm">
                <thead>
                    <tr class="border-b border-gray-600 text-gray-300">
                        <th class="py-2">Start</th>
                        <th>End</th>
                        <th>Duration (s)</th>
                        <th>Max Intensity</th>
                        <th>Avg Intensity</th>
                    </tr>
                </thead>
                <tbody id="logTable"></tbody>
            </table>
        </div>
    </div>


    <!-- JAVASCRIPT -->
    <script>
        const realtimeURL = "/api/realtime";
        const statsURL = "/api/stats";
        const logsURL = "/api/logs";

        // ---------------------------------
        // FORMAT WAKTU (KONVERSI KE WIB)
        // ---------------------------------
        function formatTime(ts) {
            const date = new Date(ts + "Z"); // pastikan dianggap UTC, lalu Chrome otomatis ubah ke lokal

            let h = String(date.getHours()).padStart(2, "0");
            let m = String(date.getMinutes()).padStart(2, "0");
            let s = String(date.getSeconds()).padStart(2, "0");

            let d = String(date.getDate()).padStart(2, "0");
            let mo = String(date.getMonth() + 1).padStart(2, "0");
            let y = String(date.getFullYear()).slice(-2);

            return `${h}:${m}:${s} • ${d}/${mo}/${y}`;
        }

        // ---------------------------------
        // CHART INITIALIZATION
        // ---------------------------------
        const ctx = document.getElementById("realtimeChart").getContext("2d");

        const realtimeChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "Max Intensity",
                    data: [],
                    borderWidth: 2,
                    borderColor: "rgba(59,130,246,0.8)",
                    backgroundColor: "rgba(59,130,246,0.3)",
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });


        // ---------------------------------
        // FETCH REALTIME STATUS
        // ---------------------------------
        async function fetchRealtime() {
            const res = await fetch(realtimeURL);
            const data = await res.json();

            document.getElementById("shakeStatus").textContent = data.shake ? "YES" : "NO";
            document.getElementById("intensity").textContent = data.intensity;
            document.getElementById("duration").textContent = data.duration;
            document.getElementById("timestamp").textContent =
                data.timestamp ? formatTime(data.timestamp) : "-";
        }


        // ---------------------------------
        // FETCH EVENT LOGS + UPDATE TABLE + CHART
        // ---------------------------------
        async function fetchLogs() {
            const res = await fetch(logsURL);
            const logs = await res.json();

            const table = document.getElementById("logTable");
            table.innerHTML = "";

            logs.forEach(row => {
                const tr = document.createElement("tr");
                tr.classList.add("border-b", "border-gray-700");

                tr.innerHTML = `
                <td class="py-2">${formatTime(row.start_time)}</td>
                <td>${formatTime(row.end_time)}</td>
                <td>${row.duration_sec}</td>
                <td>${row.max_intensity}</td>
                <td>${row.avg_intensity}</td>
            `;
                table.appendChild(tr);
            });

            // --- ambil 10 event terbaru, terbaru di kanan ---
            let last10 = logs.slice(-10).reverse();

            realtimeChart.data.labels = last10.map(e => formatTime(e.start_time));
            realtimeChart.data.datasets[0].data = last10.map(e => e.max_intensity);

            realtimeChart.update();
        }


        // ---------------------------------
        // FETCH STATS
        // ---------------------------------
        async function fetchStats() {
            const res = await fetch(statsURL);
            const data = await res.json();

            document.getElementById("avgIntensity").textContent = data.average;
            document.getElementById("minIntensity").textContent = data.minimum;
            document.getElementById("maxIntensity").textContent = data.maximum;
        }


        // intervals
        setInterval(fetchRealtime, 1000);
        setInterval(fetchLogs, 2000);
        setInterval(fetchStats, 3000);

        // initial calls
        fetchRealtime();
        fetchLogs();
        fetchStats();
    </script>


</body>

</html>