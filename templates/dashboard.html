<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Sensor Ultrasonik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard Monitoring Sensor Ultrasonik</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-2">Jarak Real-time</div>
                <div class="text-3xl font-bold text-blue-600" id="realtimeDistance">-- cm</div>
                <div class="text-xs text-gray-500 mt-2" id="realtimeTimestamp">Menunggu data...</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-2">Rata-rata</div>
                <div class="text-3xl font-bold text-green-600" id="avgDistance">-- cm</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-2">Minimum</div>
                <div class="text-3xl font-bold text-yellow-600" id="minDistance">-- cm</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-sm text-gray-600 mb-2">Maximum</div>
                <div class="text-3xl font-bold text-red-600" id="maxDistance">-- cm</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">Grafik Historis</h2>
                <select id="periodSelect" class="border border-gray-300 rounded px-3 py-1">
                    <option value="1h">1 Jam</option>
                    <option value="24h" selected>24 Jam</option>
                    <option value="7d">7 Hari</option>
                </select>
            </div>
            <canvas id="historyChart"></canvas>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Status Koneksi</h2>
            <div class="flex items-center">
                <div id="connectionStatus" class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                <span id="connectionText">Aktif</span>
            </div>
        </div>
    </div>

    <script>
        let historyChart = null;

        async function loadRealtimeData() {
            try {
                const response = await fetch('/api/realtime');
                const data = await response.json();
                
                if (data.distance !== null) {
                    document.getElementById('realtimeDistance').textContent = data.distance.toFixed(2) + ' cm';
                    const timestamp = new Date(data.timestamp).toLocaleString('id-ID');
                    document.getElementById('realtimeTimestamp').textContent = timestamp;
                    document.getElementById('connectionStatus').className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                    document.getElementById('connectionText').textContent = 'Aktif';
                }
            } catch (error) {
                console.error('Error loading realtime data:', error);
                document.getElementById('connectionStatus').className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                document.getElementById('connectionText').textContent = 'Error';
            }
        }

        async function loadStatistics() {
            try {
                const period = document.getElementById('periodSelect').value;
                const response = await fetch(`/api/statistics?period=${period}`);
                const data = await response.json();
                
                console.log('Statistics data:', data);
                
                if (data.statistics.avg_distance !== null) {
                    document.getElementById('avgDistance').textContent = parseFloat(data.statistics.avg_distance).toFixed(2) + ' cm';
                    document.getElementById('minDistance').textContent = parseFloat(data.statistics.min_distance).toFixed(2) + ' cm';
                    document.getElementById('maxDistance').textContent = parseFloat(data.statistics.max_distance).toFixed(2) + ' cm';
                }
                
                updateChart(data.history);
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function updateChart(history) {
            const labels = history.map(h => {
                const date = new Date(h.time_bucket);
                return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            });
            const distances = history.map(h => parseFloat(h.avg_distance));

            if (historyChart) {
                historyChart.destroy();
            }

            const ctx = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jarak (cm)',
                        data: distances,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jarak (cm)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Waktu'
                            }
                        }
                    }
                }
            });
        }

        document.getElementById('periodSelect').addEventListener('change', loadStatistics);

        setInterval(loadRealtimeData, 1000);

        loadRealtimeData();
        loadStatistics();
        setInterval(loadStatistics, 30000);
    </script>
</body>
</html>